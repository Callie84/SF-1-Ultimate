#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ==========================================
# Pre-Push Hook
# ==========================================
# Runs before pushing to remote to ensure code quality
#
# Checks:
# - Full test suite
# - TypeScript compilation
# - Build process
# ==========================================

echo "ðŸš€ Running pre-push checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

FAILED=0

# ==========================================
# 1. Run Full Test Suite
# ==========================================
echo "ðŸ§ª Running full test suite..."

if [ -f "package.json" ]; then
  npm test -- --coverage --passWithNoTests

  if [ $? -ne 0 ]; then
    echo "${RED}âœ—${NC} Tests failed"
    FAILED=1
  else
    echo "${GREEN}âœ“${NC} All tests passed"
  fi
fi

echo ""

# ==========================================
# 2. Run Tests in Each Service
# ==========================================
echo "ðŸ”§ Running service-specific tests..."

for service_dir in apps/*/; do
  if [ -f "$service_dir/package.json" ]; then
    service_name=$(basename "$service_dir")
    echo "  Testing: $service_name"

    (cd "$service_dir" && npm test -- --passWithNoTests)

    if [ $? -ne 0 ]; then
      echo "${RED}âœ—${NC} Tests failed in $service_name"
      FAILED=1
    else
      echo "${GREEN}âœ“${NC} Tests passed in $service_name"
    fi
  fi
done

echo ""

# ==========================================
# 3. TypeScript Compilation
# ==========================================
echo "ðŸ“˜ Running TypeScript compilation..."

for service_dir in apps/*/; do
  if [ -f "$service_dir/tsconfig.json" ]; then
    service_name=$(basename "$service_dir")
    echo "  Compiling: $service_name"

    (cd "$service_dir" && tsc --noEmit)

    if [ $? -ne 0 ]; then
      echo "${RED}âœ—${NC} TypeScript compilation failed in $service_name"
      FAILED=1
    else
      echo "${GREEN}âœ“${NC} TypeScript compilation passed in $service_name"
    fi
  fi
done

echo ""

# ==========================================
# 4. Check for Untracked Files
# ==========================================
echo "ðŸ“‚ Checking for untracked files..."

UNTRACKED=$(git ls-files --others --exclude-standard | wc -l)

if [ $UNTRACKED -gt 0 ]; then
  echo "${YELLOW}âš ${NC} You have $UNTRACKED untracked files:"
  git ls-files --others --exclude-standard | head -10 | sed 's/^/  /'

  if [ $UNTRACKED -gt 10 ]; then
    echo "  ... and $((UNTRACKED - 10)) more"
  fi

  echo ""
  echo "  Consider adding them to .gitignore if they shouldn't be tracked"
  echo "  (This is a warning, not blocking the push)"
fi

echo ""

# ==========================================
# Summary
# ==========================================
if [ $FAILED -eq 1 ]; then
  echo "${RED}âœ— Pre-push checks failed${NC}"
  echo ""
  echo "Please fix the errors above before pushing."
  echo ""
  echo "To skip these checks (NOT recommended):"
  echo "  git push --no-verify"
  echo ""
  exit 1
else
  echo "${GREEN}âœ… All pre-push checks passed!${NC}"
  echo ""
  echo "Safe to push! ðŸš€"
  echo ""
  exit 0
fi
