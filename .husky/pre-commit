#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ==========================================
# Pre-Commit Hook
# ==========================================
# Runs before each commit to ensure code quality
#
# Checks:
# - ESLint (code linting)
# - Prettier (code formatting)
# - TypeScript compilation
# - Unit tests
# ==========================================

echo "ðŸ” Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Track if any check fails
FAILED=0

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')

if [ -z "$STAGED_FILES" ]; then
  echo "${GREEN}âœ“${NC} No TypeScript/JavaScript files to check"
  exit 0
fi

echo ""
echo "ðŸ“ Staged files:"
echo "$STAGED_FILES" | sed 's/^/  /'
echo ""

# ==========================================
# 1. ESLint
# ==========================================
echo "ðŸ” Running ESLint..."

if command -v eslint &> /dev/null; then
  echo "$STAGED_FILES" | xargs eslint --max-warnings 0

  if [ $? -ne 0 ]; then
    echo "${RED}âœ—${NC} ESLint found errors"
    echo ""
    echo "Fix errors with: npm run lint:fix"
    FAILED=1
  else
    echo "${GREEN}âœ“${NC} ESLint passed"
  fi
else
  echo "${YELLOW}âš ${NC} ESLint not installed, skipping..."
fi

echo ""

# ==========================================
# 2. Prettier
# ==========================================
echo "ðŸ’… Checking code formatting..."

if command -v prettier &> /dev/null; then
  echo "$STAGED_FILES" | xargs prettier --check

  if [ $? -ne 0 ]; then
    echo "${RED}âœ—${NC} Code formatting issues found"
    echo ""
    echo "Auto-fix with: npm run format"
    echo "Or run: prettier --write <file>"
    FAILED=1
  else
    echo "${GREEN}âœ“${NC} Code formatting passed"
  fi
else
  echo "${YELLOW}âš ${NC} Prettier not installed, skipping..."
fi

echo ""

# ==========================================
# 3. TypeScript Type Checking
# ==========================================
echo "ðŸ“˜ Running TypeScript type checking..."

if command -v tsc &> /dev/null; then
  # Run tsc in each service that has staged files
  for file in $STAGED_FILES; do
    if [[ $file == apps/* ]]; then
      service_dir=$(echo $file | cut -d'/' -f1-2)

      if [ -f "$service_dir/tsconfig.json" ]; then
        echo "  Checking: $service_dir"
        (cd "$service_dir" && tsc --noEmit)

        if [ $? -ne 0 ]; then
          echo "${RED}âœ—${NC} TypeScript errors in $service_dir"
          FAILED=1
        else
          echo "${GREEN}âœ“${NC} TypeScript check passed for $service_dir"
        fi
      fi
    fi
  done
else
  echo "${YELLOW}âš ${NC} TypeScript not installed, skipping..."
fi

echo ""

# ==========================================
# 4. Run Unit Tests (for changed files)
# ==========================================
echo "ðŸ§ª Running unit tests for changed files..."

if command -v jest &> /dev/null; then
  # Find test files related to changed files
  TEST_FILES=""

  for file in $STAGED_FILES; do
    # Convert src file to test file
    test_file=$(echo $file | sed 's/\.ts$/.test.ts/' | sed 's/src\//src\/__tests__\//')

    if [ -f "$test_file" ]; then
      TEST_FILES="$TEST_FILES $test_file"
    fi
  done

  if [ -n "$TEST_FILES" ]; then
    echo "$TEST_FILES" | xargs jest --bail --findRelatedTests

    if [ $? -ne 0 ]; then
      echo "${RED}âœ—${NC} Unit tests failed"
      FAILED=1
    else
      echo "${GREEN}âœ“${NC} Unit tests passed"
    fi
  else
    echo "${YELLOW}âš ${NC} No related test files found"
  fi
else
  echo "${YELLOW}âš ${NC} Jest not installed, skipping..."
fi

echo ""

# ==========================================
# 5. Check for console.log (warn only)
# ==========================================
echo "ðŸ”Ž Checking for console.log statements..."

CONSOLE_LOGS=$(echo "$STAGED_FILES" | xargs grep -n "console\.log" 2>/dev/null || true)

if [ -n "$CONSOLE_LOGS" ]; then
  echo "${YELLOW}âš ${NC} Found console.log statements:"
  echo "$CONSOLE_LOGS" | sed 's/^/  /'
  echo ""
  echo "  Consider using a proper logger instead"
  echo "  (This is a warning, not blocking the commit)"
fi

echo ""

# ==========================================
# Summary
# ==========================================
if [ $FAILED -eq 1 ]; then
  echo "${RED}âœ— Pre-commit checks failed${NC}"
  echo ""
  echo "Please fix the errors above before committing."
  echo ""
  echo "Quick fixes:"
  echo "  - ESLint:    npm run lint:fix"
  echo "  - Prettier:  npm run format"
  echo "  - Tests:     npm test"
  echo ""
  echo "To skip these checks (NOT recommended):"
  echo "  git commit --no-verify"
  echo ""
  exit 1
else
  echo "${GREEN}âœ… All pre-commit checks passed!${NC}"
  echo ""
  exit 0
fi
